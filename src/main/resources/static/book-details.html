<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Details</title>
    <link rel="stylesheet" href="/styles/book_details.css">
</head>
<body>
<header>
    <div class="logo">OneMoreChapter</div>
    <nav>
        <a href="home.html">Home</a>
        <a href="loan.html">Books on Loan</a>
        <a href="inventory.html">My Inventory</a>
        <a href="reading.html">Currently Reading</a>
        <a href="requests.html">Requests</a>
    </nav>
</header>

<main>
    <div class="book-details-container">
        <div class="book-image">
            <img id="bookImage" src="https://via.placeholder.com/320x450" alt="Book Cover">
        </div>
        <div class="book-info">
            <h1 id="bookTitle">Loading...</h1>
            <p><strong>Author:</strong> <span id="bookAuthor">...</span></p>
            <p><strong>Genre:</strong> <span id="bookGenre">...</span></p>
            <p><strong>Description:</strong> <span id="bookDescription">...</span></p>
            <div class="owner-section">
                <p><strong>Owner:</strong> <span id="bookOwner">...</span></p>
                <p><strong>Location:</strong> <span id="bookOwnerLocation">...</span></p>
            </div>
            <div class="action-buttons">
                <button class="request-button" onclick="sendRequest()">Request Book</button>
                <button class="message-button" onclick="messageOwner()">Message Owner</button>
            </div>
        </div>
    </div>
</main>

<script>
    function messageOwner() {
        const ownerName = document.getElementById("bookOwner").textContent.trim();
        const loggedInUser = sessionStorage.getItem("username") || "UnknownUser";

        if (!ownerName || ownerName === "Unknown Owner") {
            alert("No valid owner found.");
            return;
        }

        // âœ… Redirect to messages page with owner pre-selected
        window.location.href = `messages.html?chat_with=${encodeURIComponent(ownerName)}&from=${encodeURIComponent(loggedInUser)}`;
    }

    async function loadBookDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get("bookId");

        if (!bookId) {
            alert("Invalid book ID. Redirecting to home.");
            window.location.href = "home.html";
            return;
        }

        try {
            const bookResponse = await fetch(`http://localhost:8080/books/${bookId}`);
            if (!bookResponse.ok) throw new Error("Book not found");
            const bookData = await bookResponse.json();

            document.getElementById("bookImage").src = bookData.image || "https://via.placeholder.com/320x450";
            document.getElementById("bookTitle").textContent = bookData.title;
            document.getElementById("bookAuthor").textContent = bookData.author || "Unknown Author";
            document.getElementById("bookGenre").textContent = bookData.genre || "Unknown Genre";
            document.getElementById("bookDescription").textContent = bookData.description || "No description provided.";

            const ownerResponse = await fetch(`http://localhost:8080/users/${bookData.ownerId}`);
            if (!ownerResponse.ok) throw new Error("Owner not found");
            const ownerData = await ownerResponse.json();

            document.getElementById("bookOwner").textContent = ownerData.username || "Unknown Owner";
            document.getElementById("bookOwnerLocation").textContent = ownerData.location || "Unknown Location";
        } catch (error) {
            console.error("Error fetching book details:", error);
            alert("Failed to load book details.");
        }
    }

    document.addEventListener("DOMContentLoaded", loadBookDetails);
</script>

</body>
</html>
