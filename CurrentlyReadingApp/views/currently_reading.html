<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Currently Reading</title>
    <link rel="stylesheet" href="styles/currently_reading.css" />
  </head>
  <body>
    <header>
      <div class="logo">OneMoreChapter</div>
      <nav>
        <a href="homepage.html">Home</a>
        <a href="books_onLoan.html">Books on Loan</a>
        <a href="my_inventory.html">My Inventory</a>
        <a href="currently_reading.html" class="active">Currently Reading</a>
        <a href="requests.html">Requests</a>
      </nav>
      <div class="icon-bar">
        <!-- Search Icon -->
        <svg
          class="icon"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
        >
          <path
            d="M10 2a8 8 0 015.293 13.707l4 4a1 1 0 01-1.414 1.414l-4-4A8 8 0 1110 2zm0 2a6 6 0 100 12 6 6 0 000-12z"
          ></path>
        </svg>
        <!-- Messaging Icon -->
        <a href="messages.html">
          <svg
            class="icon"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
          >
            <path
              d="M20 2H4a2 2 0 00-2 2v12a2 2 0 002 2h4l4 4v-4h8a2 2 0 002-2V4a2 2 0 00-2-2zm0 12H10v2.586L8.414 14H4V4h16v10z"
            ></path>
          </svg>
        </a>
        <!-- Profile Dropdown -->
        <div class="profile-dropdown">
          <a href="#" class="profile-icon">
            <svg
              class="icon"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
            >
              <path
                d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4.418 0-8 2.015-8 4.5V21h16v-2.5c0-2.485-3.582-4.5-8-4.5z"
              ></path>
            </svg>
          </a>
          <div class="dropdown-menu">
            <a href="profile.html">Profile</a>
            <a href="settings.html">Account Settings</a>
            <a href="logout.html">Logout</a>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="page-title">
        <h2>Currently Reading</h2>
      </div>
      <ul id="bookList"></ul>
      <table>
        <thead>
          <tr>
            <th>Borrowed Books</th>
            <th>From</th>
            <th>Return Book</th>
          </tr>
        </thead>
        <tbody>
          <tr> id="book-1" data-id="1"> 
            <td>
              <div class="book-placeholder"></div>
              <span class="book-title">Book Title 1</span>
            </td>
            <td>
              <div class="user-placeholder"></div>
              <span>Name</span>
            </td>
            <td>
              <button class="returned-btn" onclick="returnBook(1)">Return</button>
            </td>
          </tr>
          <tr> id="book-2" data-id="2">
            <td>
              <div class="book-placeholder"></div>
              <span class="book-title">Book Title 2</span>
            </td>
            <td>
              <div class="user-placeholder"></div>
              <span>Name</span>
            </td>
            <td>
              <button class="returned-btn" onclick="returnBook(2)">Return</button>
            </td>
          </tr>
          <tr> id="book-3" data-id="3">
            <td>
              <div class="book-placeholder"></div>
              <span class="book-title">Book Title 3</span>
            </td>
            <td>
              <div class="user-placeholder"></div>
              <span>Name</span>
            </td>
            <td>
              <button class="returned-btn" onclick="returnBook(3)">Return</button>
            </td>
          </tr>
        </tbody>
      </table>
    </main>
    <script>
      // This function will send a DELETE request to your server when the button is clicked
      function returnBook(bookId) {
        // Send the DELETE request to your server with the bookId
        fetch(`/api/return_book/${bookId}`, {
          method: 'DELETE',
        })
          .then(response => response.json()) // Convert the response to JSON
          .then(data => {
            // If the response is successful, remove the book row from the page
            if (data.message === "Book returned successfully") {
              // Remove the row with the id of book-<bookId>
              document.getElementById(`book-${bookId}`).remove();
            } else {
              alert('Error: Could not return the book');
            }
          })
          .catch(error => console.error('Error:', error)); // Log any error
      }
    </script>
    <script>
      // Get the logged-in user's name from the URL (e.g., ?user=username)
      const urlParams = new URLSearchParams(window.location.search);
      const loggedInUser = urlParams.get('user'); // Fetch the username
      
      if (!loggedInUser) {
          alert('User not logged in');
          window.location.href = '/';  // Redirect to login if no user info
      }
      
      // Fetch the books for the logged-in user
      fetch(`/api/currently_reading?user=${loggedInUser}`)
          .then(response => response.json())
          .then(books => {
              const bookList = document.getElementById('bookList');
              books.forEach(book => {
                  const li = document.createElement('li');
                  li.innerHTML = `${book.title} <button onclick="returnBook(${book.id})">Return</button>`;
                  bookList.appendChild(li);
              });
          })
          .catch(error => {
              console.log('Error fetching books:', error);
          });
      
      // Function to handle the "Return" button
      function returnBook(bookId) {
          fetch(`/api/return_book/${bookId}`, {
              method: 'DELETE',  // Use DELETE to remove the book
          })
          .then(response => response.json())
          .then(data => {
              alert(data.message);  // Show success message
              window.location.reload();  // Reload to see the updated list
          })
          .catch(error => {
              console.log('Error returning book:', error);
          });
      }
      </script>      
  </body>
</html>
